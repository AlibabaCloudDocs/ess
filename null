---
keyword: [lifecycle hook, OOS template, ENI, EIP]
---

# Customize an ECS instance during a scaling activity

If you want to execute operations and maintenance \(O&M\) tasks for newly created ECS instances during a scale-out event or for ECS instances that are to be released during a scale-in event, you can use lifecycle hooks of Auto Scaling to put the instances into the wait state. Then, you can use Operation Orchestration Service \(OOS\) templates to customize the configurations of ECS instances for more flexible management.

-   Before you perform the operations provided in the tutorial, you must have registered an Alibaba Cloud account. To create an Alibaba Cloud account, click [Create a new Alibaba Cloud account](https://account.alibabacloud.com/register/intl_register.htm).
-   A scaling group is created and enabled.
-   The OOSServiceRole RAM role is created for OOS. For more information, see [Grant RAM permission for OOS](https://www.alibabacloud.com/help/doc-detail/120810.htm).

OOS is an automated O&M service provided by Alibaba Cloud, which helps you manage and execute O&M tasks. You can define execution tasks, the order in which to execute the tasks, input parameters, and output parameters in templates and use these templates to automate O&M tasks. For more information, see [Introduction to OOS](https://www.alibabacloud.com/help/doc-detail/120556.htm).

You can set the notification method to OOS Template and specify an OOS template when you create a lifecycle hook in a scaling group. During scaling activities, ECS instances in the scaling group are put into the wait state and then OOS performs the customized O&M operations specified in the template on the ECS instances. For more information, see [Create a lifecycle hook](/intl.en-US/Scaling Group/Lifecycle hooks/Create a lifecycle hook.md).

We recommend that you use lifecycle hooks and OOS templates to automatically execute O&M tasks for the following scenarios:

-   If a scaling group is used to automatically respond to traffic spikes during peak hours, applications on ECS instances that are scaled out must be first started. Then, the instances are automatically registered with the resource management center to process business traffic.
-   A scaling group needs to be associated with PolarDB instances. After the scaling group is associated with PolarDB instances, the IP addresses of ECS instances in the scaling group are added to the whitelists of the PolarDB instances during scale-out events and are removed from the whitelists of the PolarDB instances during scale-in events.
-   During scale-in events, you need to copy some logs that are stored on the ECS instances to be deleted.

## Procedure

The following example uses the ACS-ESS-LifeCycleCreateNetworkInterfaceAndEipAndAttachToInstance OOS public template to demonstrate how to bind a secondary elastic network interface \(ENI\) to and associate an elastic IP address \(EIP\) with all the created ECS instances during scale-out events. Perform the following steps:

-   [Step 1: Grant OOS permissions to the RAM user](#section_onb_kyb_1xg)
-   [Step 2: Create a lifecycle hook for scale-out events and trigger scale-out events](#section_ixt_52h_nq5)
-   [Step 3 \(optional\): View the execution status of the OOS template](#section_dvu_jn8_f76)

## Step 1: Grant OOS permissions to the RAM user

You must be granted the permissions to execute OOS templates. Resources of ECS, Auto Scaling, and Elastic IP Address are involved when the O&M operations that are specified in the ACS-ESS-LifeCycleCreateNetworkInterfaceAndEipAndAttachToInstance template are performed.

1.  Log on to the [RAM console](https://ram.console.aliyun.com/).

2.  In the left-side navigation pane, click **RAM Roles**.

3.  Find the OOSServiceRole RAM role and click **Add Permissions** in the **Actions** column.

    Attach policies to the OOSServiceRole RAM role that is assumed by OOS to complete the authorization.

4.  In the **Add Permissions** pane, configure the parameters and click **OK**.

    The following table describes the parameters used in this example. Use the default values for parameters that are not mentioned in the table.

    |Parameter|Description|
    |---------|-----------|
    |**Authorization**|Select **Alibaba Cloud account all resources**.|
    |**Select Policy**|Add the AliyunECSFullAccess, AliyunESSFullAccess, and AliyunEIPFullAccess system policies.|


## Step 2: Create a lifecycle hook for scale-out events and trigger scale-out events

1.  Log on to the [Auto Scaling console](https://essnew.console.aliyun.com/).

2.  In the left-side navigation pane, click **Scaling Groups**.

3.  In the top navigation bar, select a region.

4.  Find the scaling group and use one of the following methods to open the details page of the scaling group:

    -   Click the ID of the scaling group in the **Scaling Group Name/ID** column.
    -   Click **Details** in the **Actions** column.
5.  Create a lifecycle hook for scale-out events.

    1.  In the left-side navigation pane, click **Lifecycle Hooks**.

    2.  Configure parameters for the lifecycle hook and click **OK**.

        The following table describes the parameters used in this example. Use the default values for parameters that are not mentioned in the table.

        |Parameter|Description|
        |---------|-----------|
        |**Name**|Enter ESSHookForAddNicEip.|
        |**Applicable Scaling Activity Type**|Select **Scale-out Event**.|
        |**Timeout Period**|Enter a proper value, such as 300.**Note:** The timeout period is the period of time during which to perform customized operations. If the period is short, the operations may fail to be performed. Estimate the time required to perform the operations and set a proper timeout period. |
        |**Execution Policy**|Select **Continue**.|
        |**Notification Method**|The following section describes the template configurations:        -   Notification method: Select **OOS Template**.
        -   OOS template type: Select **Public Templates**.
        -   Public template: Select ACS-ESS-LifeCycleCreateNetworkInterfaceAndEipAndAttachToInstance.
The following section describes the parameters for the ACS-ESS-LifeCycleCreateNetworkInterfaceAndEipAndAttachToInstance template:

        -   **internetChargeType**: Select PayByBandwidth, which indicates that you are charged based on bandwidth when you use an EIP.
        -   **bandwidth**: Enter 5, which indicates that the peak bandwidth of the EIP is 5 Mbit/s.
        -   **Permissions**: Select OOSServiceRole. In Step 1, the OOSServiceRole RAM role is granted permissions to manage ECS, Auto Scaling, and Elastic IP Address resources. OSS owns the preceding permissions after it assumes the RAM role. |

6.  Trigger a scale-out event.

    A scale-out event is triggered in this example by manually executing a scaling rule. You can also trigger scale-out events by using scheduled or event-triggered tasks.

    **Note:** ECS instances that are created or removed by manually executing a scaling rule are different from those that are manually added to or removed from a scaling group. ECS instances that are manually added to a scaling group are not put into the wait state by lifecycle hooks.

    1.  In the left-side navigation pane, click **Scaling Rules**.

    2.  In the upper-left corner of the Scaling Rules page, click **Create Scaling Rule**.

    3.  In the Create Scaling Rule dialog box, configure required parameters and click **OK**.

        The following table describes the parameters used in this example. Use the default values for parameters that are not mentioned in the table.

        |Parameter|Description|
        |---------|-----------|
        |**Rule Name**|Enter Add1.|
        |**Rule Type**|Select **Simple Scaling Rule**.|
        |**Operation**|Set this parameter to Add 1 Instances.|

    4.  On the **Scaling Rules** page, find the created Add1 scaling rule and click **Execute** in the **Actions** column.

    5.  In the **Execute Scaling Rule** message, click **OK**.

    After the scaling rule is executed, an ECS instance is automatically created. The ECS instance is put into the wait state because the ESSHookForAddNicEip lifecycle hook is created in the scaling group. Additionally, Auto Scaling automatically notifies OOS to perform the customized O&M operations that are specified in the ACS-ESS-LifeCycleCreateNetworkInterfaceAndEipAndAttachToInstance template.

    If the scaling activity fails, the following error information appears. Go to the OOS console to view the execution result of O&M tasks. For more information, see [Step 3 \(optional\): View the execution status of the OOS template](#section_dvu_jn8_f76).

    ![Scaling activity failure](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/en-US/5125821061/p133074.png)

7.  Check whether the automatically created ECS instance meets your requirements.

    1.  In the left-side navigation pane, click **ECS Instances**.

    2.  Find the automatically created instance and click its ID in the **ECS Instance ID/Name** column.

    3.  In the left-side navigation pane, click **Elastic Network Interfaces**.

        In addition to the primary ENI, the ECS instance is bound with a secondary ENI and associated with an EIP, as shown in the following figure. The O&M tasks specified in the ACS-ESS-LifeCycleCreateNetworkInterfaceAndEipAndAttachToInstance template are performed and the execution result meets your expectations.

        ![The automatically bound secondary ENI](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/en-US/6125821061/p133063.png)

        If an ECS instance is created, but the instance is not bound with a secondary ENI or associated with an EIP, go to the OOS console to view the execution results of O&M tasks. For more information, see [Step 3 \(optional\): View the execution status of the OOS template](#section_dvu_jn8_f76).


## Step 3 \(optional\): View the execution status of the OOS template

1.  Log on to the [OOS console](https://oos.console.aliyun.com/).

2.  In the left-side navigation pane, click **Executions**.

3.  Find the corresponding execution task by time and click **Details** in the **Actions** column.

4.  Click the **Advanced View** tab.

    The execution status appears on the **Execution Result** tab.

    ![View the execution status](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/en-US/6125821061/p132765.png)

    If the execution fails, the error message appears on the **Execution Result** tab.

    ![OOS execution result](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/en-US/6125821061/p133032.png)


## FAQ

If an O&M task fails to be executed, find the cause based on the error message in the execution result. The following section describes the common error messages and their solutions:

-   Error message: Forbidden.Unauthorized message: A required authorization for the specified action is not supplied.

    Solution: Check whether you have granted the required permissions to the OOSServiceRole RAM role, such as the sample permissions in Step 1. You must grant required permissions to the OOSServiceRole RAM role to make sure that OOS can manage the resources that are involved in OOS templates.

-   Error message: Forbidden.RAM message: User not authorized to operate on the specified resource, or this API doesn't support RAM.

    Solution: Check whether you have granted the required permissions to the OOSServiceRole RAM role, such as the sample permissions in Step 1. You must grant required permissions to the OOSServiceRole RAM role to make sure that OOS can manage the resources that are involved in OOS templates.

-   Error message: LifecycleHookIdAndLifecycleActionToken.Invalid message: The specified lifecycleActionToken and lifecycleActionId you provided does not match any in process lifecycle action.

    Solution: Estimate the timeout period of the lifecycle hook to make sure that the O&M task that is specified in the OOS template can be complete within the timeout period.


